#!/bin/bash
# ==========================================
# DevKit - é–‹ç™¼å·¥å…·åŒ… CLI
# ä½œè€…: æå¡çˆ¾
# åŠŸèƒ½: çµ±ä¸€ç®¡ç†å’ŒåŸ·è¡Œæ‰€æœ‰é–‹ç™¼è…³æœ¬å·¥å…·
# ä½¿ç”¨æ–¹å¼: devkit [command] [options]
# ==========================================

# è…³æœ¬åŸºæœ¬è·¯å¾‘
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
TOOLS_DIR="$SCRIPT_DIR"

# å½©è‰²è¼¸å‡º
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

VERSION="1.0.0"

# é¡¯ç¤ºç‰ˆæœ¬è³‡è¨Š
show_version() {
    echo -e "${BOLD}DevKit v${VERSION}${NC}"
    echo "é–‹ç™¼å·¥å…·åŒ… - çµ±ä¸€ç®¡ç†æ‰€æœ‰é–‹ç™¼è…³æœ¬"
}

# é¡¯ç¤ºä½¿ç”¨èªªæ˜
show_help() {
    show_version
    echo ""
    echo -e "${CYAN}ä½¿ç”¨æ–¹å¼ï¼š${NC}"
    echo "  devkit [command] [options]"
    echo ""
    echo -e "${CYAN}å‘½ä»¤ï¼š${NC}"
    echo "  list                     é¡¯ç¤ºæ‰€æœ‰å¯ç”¨å·¥å…·"
    echo "  <category>               é¡¯ç¤ºç‰¹å®šåˆ†é¡çš„å·¥å…·"
    echo "  <category>:<tool>        åŸ·è¡ŒæŒ‡å®šå·¥å…·"
    echo "  --interactive, -i        äº’å‹•å¼é¸å–®"
    echo "  --help, -h               é¡¯ç¤ºæ­¤èªªæ˜"
    echo "  --version, -v            é¡¯ç¤ºç‰ˆæœ¬è³‡è¨Š"
    echo ""
    echo -e "${CYAN}ç¯„ä¾‹ï¼š${NC}"
    echo "  devkit                   # é¡¯ç¤ºæ‰€æœ‰å·¥å…·"
    echo "  devkit git               # é¡¯ç¤º git å·¥å…·"
    echo "  devkit git:release-tag   # åŸ·è¡Œç‰ˆæœ¬æ¨™ç±¤å·¥å…·"
    echo "  devkit -i                # äº’å‹•å¼é¸å–®"
}

# ç²å–æ‰€æœ‰åˆ†é¡
get_categories() {
    # æƒæ bash-tools ç›®éŒ„
    for category_dir in "$TOOLS_DIR"/bash-tools/*/; do
        if [ -d "$category_dir" ]; then
            local category_name=$(basename "$category_dir")
            
            # è·³ééš±è—ç›®éŒ„å’Œéå·¥å…·ç›®éŒ„
            if [[ "$category_name" != .* ]] && [[ "$category_name" != "node_modules" ]]; then
                # æª¢æŸ¥æ˜¯å¦æœ‰ .sh æª”æ¡ˆ
                if ls "$category_dir"/*.sh >/dev/null 2>&1; then
                    echo "$category_name"
                fi
            fi
        fi
    done
    
    # æƒæ node-tools ç›®éŒ„
    for category_dir in "$TOOLS_DIR"/node-tools/*/; do
        if [ -d "$category_dir" ]; then
            local category_name=$(basename "$category_dir")
            
            # è·³ééš±è—ç›®éŒ„å’Œéå·¥å…·ç›®éŒ„
            if [[ "$category_name" != .* ]] && [[ "$category_name" != "node_modules" ]]; then
                # æª¢æŸ¥æ˜¯å¦æœ‰ package.json æˆ– CLI å…¥å£
                if [ -f "$category_dir/package.json" ] || [ -f "$category_dir/src/cli.js" ]; then
                    echo "$category_name"
                fi
            fi
        fi
    done
}

# ç²å–åˆ†é¡ä¸‹çš„å·¥å…·
get_category_tools() {
    local category="$1"
    local bash_category_dir="$TOOLS_DIR/bash-tools/$category"
    local node_category_dir="$TOOLS_DIR/node-tools/$category"
    
    # æª¢æŸ¥ bash-tools ç›®éŒ„
    if [ -d "$bash_category_dir" ]; then
        for script_file in "$bash_category_dir"/*.sh; do
            if [ -f "$script_file" ]; then
                local tool_name=$(basename "$script_file" .sh)
                local description=""
                
                # å˜—è©¦å¾è…³æœ¬ä¸­æå–æè¿°
                description=$(grep "^# DEVKIT_DESC:" "$script_file" 2>/dev/null | sed 's/^# DEVKIT_DESC: *//' | head -1)
                if [ -z "$description" ]; then
                    description=$(grep "^# åŠŸèƒ½:" "$script_file" 2>/dev/null | sed 's/^# åŠŸèƒ½: *//' | head -1)
                fi
                if [ -z "$description" ]; then
                    description="$tool_name å·¥å…·"
                fi
                
                echo "$tool_name|$script_file|$description"
            fi
        done
    fi
    
    # æª¢æŸ¥ node-tools ç›®éŒ„
    if [ -d "$node_category_dir" ]; then
        # Node.js å·¥å…·é€šå¸¸æœ‰çµ±ä¸€çš„ CLI å…¥å£
        if [ -f "$node_category_dir/src/cli.js" ]; then
            # å¾ package.json å–å¾—æè¿°
            local description=""
            if [ -f "$node_category_dir/package.json" ]; then
                description=$(grep '"description"' "$node_category_dir/package.json" 2>/dev/null | sed 's/.*"description": *"\([^"]*\)".*/\1/')
            fi
            if [ -z "$description" ]; then
                description="$category Node.js å·¥å…·"
            fi
            
            echo "$category|$node_category_dir/src/cli.js|$description"
        fi
    fi
}

# é¡¯ç¤ºæ‰€æœ‰å·¥å…·æ¸…å–®
show_all_tools() {
    echo -e "${BOLD}ğŸ› ï¸  Development Toolkit${NC}"
    echo ""
    
    local categories=($(get_categories))
    
    if [ ${#categories[@]} -eq 0 ]; then
        echo -e "${YELLOW}âš ï¸  æ²’æœ‰æ‰¾åˆ°ä»»ä½•å·¥å…·${NC}"
        echo -e "${CYAN}ğŸ’¡ è«‹ç¢ºèª scripts ç›®éŒ„ä¸‹æœ‰å¯ç”¨çš„è…³æœ¬æª”æ¡ˆ${NC}"
        return
    fi
    
    echo -e "${CYAN}ğŸ“‚ å¯ç”¨åˆ†é¡ï¼š${NC}"
    for category in "${categories[@]}"; do
        local tool_count=$(get_category_tools "$category" | wc -l)
        local category_display=$(echo "$category" | sed 's/./\U&/')
        echo "  $category     - $category_display ç›¸é—œå·¥å…· ($tool_count å€‹å·¥å…·)"
    done
    
    echo ""
    echo -e "${CYAN}ğŸ”§ æ‰€æœ‰å·¥å…·ï¼š${NC}"
    
    for category in "${categories[@]}"; do
        local category_display=$(echo "$category" | sed 's/./\U&/')
        echo -e "${BOLD}  $category_display:${NC}"
        
        get_category_tools "$category" | while IFS='|' read -r tool_name script_path description; do
            echo "    $tool_name  - $description"
        done
        echo ""
    done
    
    echo -e "${CYAN}ğŸ’¡ ä½¿ç”¨æ–¹å¼ï¼š${NC}"
    echo "  devkit <category>                # é¡¯ç¤ºåˆ†é¡å·¥å…·"
    echo "  devkit <category>:<tool>         # åŸ·è¡ŒæŒ‡å®šå·¥å…·"
    echo "  devkit --help <category>:<tool>  # é¡¯ç¤ºå·¥å…·èªªæ˜"
}

# é¡¯ç¤ºç‰¹å®šåˆ†é¡çš„å·¥å…·
show_category_tools() {
    local category="$1"
    
    local categories=($(get_categories))
    local category_exists=false
    
    for cat in "${categories[@]}"; do
        if [ "$cat" = "$category" ]; then
            category_exists=true
            break
        fi
    done
    
    if [ "$category_exists" = false ]; then
        echo -e "${RED}âŒ åˆ†é¡ '$category' ä¸å­˜åœ¨${NC}"
        echo ""
        echo -e "${CYAN}å¯ç”¨åˆ†é¡ï¼š${NC}"
        for cat in "${categories[@]}"; do
            echo "  $cat"
        done
        return 1
    fi
    
    local category_display=$(echo "$category" | sed 's/./\U&/')
    echo -e "${BOLD}ğŸ”§ $category_display å·¥å…·ï¼š${NC}"
    echo ""
    
    local tools=($(get_category_tools "$category"))
    
    if [ ${#tools[@]} -eq 0 ]; then
        echo -e "${YELLOW}âš ï¸  è©²åˆ†é¡ä¸‹æ²’æœ‰å¯ç”¨å·¥å…·${NC}"
        return
    fi
    
    get_category_tools "$category" | while IFS='|' read -r tool_name script_path description; do
        echo "  $tool_name  - $description"
    done
    
    echo ""
    echo -e "${CYAN}ğŸ’¡ ä½¿ç”¨æ–¹å¼ï¼š${NC}"
    echo "  devkit ${category}:<tool>  # åŸ·è¡ŒæŒ‡å®šå·¥å…·"
}

# åŸ·è¡ŒæŒ‡å®šå·¥å…·
execute_tool() {
    local tool_spec="$1"
    shift
    local args="$@"
    
    # è§£æ category:tool æ ¼å¼
    if [[ "$tool_spec" != *":"* ]]; then
        echo -e "${RED}âŒ å·¥å…·æ ¼å¼éŒ¯èª¤ï¼Œæ‡‰ç‚º category:tool${NC}"
        return 1
    fi
    
    local category="${tool_spec%:*}"
    local tool_name="${tool_spec#*:}"
    
    # æŸ¥æ‰¾å·¥å…·
    local found_tool=$(get_category_tools "$category" | grep "^${tool_name}|")
    
    if [ -z "$found_tool" ]; then
        echo -e "${RED}âŒ å·¥å…· '$tool_spec' ä¸å­˜åœ¨${NC}"
        echo ""
        echo -e "${CYAN}è©²åˆ†é¡ä¸‹çš„å¯ç”¨å·¥å…·ï¼š${NC}"
        get_category_tools "$category" | while IFS='|' read -r name path desc; do
            echo "  devkit ${category}:${name}"
        done
        return 1
    fi
    
    local script_path=$(echo "$found_tool" | cut -d'|' -f2)
    local description=$(echo "$found_tool" | cut -d'|' -f3)
    
    echo -e "${BLUE}ğŸš€ åŸ·è¡Œå·¥å…·ï¼š$tool_spec${NC}"
    echo -e "${CYAN}æè¿°ï¼š$description${NC}"
    echo ""
    
    # æª¢æŸ¥è…³æœ¬æ˜¯å¦å­˜åœ¨
    if [ ! -f "$script_path" ]; then
        echo -e "${RED}âŒ è…³æœ¬æª”æ¡ˆä¸å­˜åœ¨ï¼š$script_path${NC}"
        return 1
    fi
    
    # åˆ¤æ–·æ˜¯ Bash å·¥å…·é‚„æ˜¯ Node.js å·¥å…·
    if [[ "$script_path" == *"/bash-tools/"* ]]; then
        # Bash å·¥å…·
        execute_bash_tool "$script_path" $args
    elif [[ "$script_path" == *"/node-tools/"* ]]; then
        # Node.js å·¥å…·
        execute_node_tool "$category" "$tool_name" $args
    else
        echo -e "${RED}âŒ ç„¡æ³•è­˜åˆ¥å·¥å…·é¡å‹ï¼š$script_path${NC}"
        return 1
    fi
}

# åŸ·è¡Œ Bash å·¥å…·
execute_bash_tool() {
    local script_path="$1"
    shift
    local args="$@"
    
    # æª¢æŸ¥è…³æœ¬æ˜¯å¦å¯åŸ·è¡Œ
    if [ ! -x "$script_path" ]; then
        echo -e "${YELLOW}âš ï¸  è¨­å®šè…³æœ¬åŸ·è¡Œæ¬Šé™...${NC}"
        chmod +x "$script_path"
    fi
    
    # åŸ·è¡Œè…³æœ¬
    "$script_path" $args
}

# åŸ·è¡Œ Node.js å·¥å…·
execute_node_tool() {
    local category="$1"
    local tool_name="$2"
    shift 2
    local args="$@"
    
    local node_tool_dir="$TOOLS_DIR/node-tools/$category"
    
    # æª¢æŸ¥ Node.js å’Œ pnpm
    if ! command -v node &> /dev/null; then
        echo -e "${RED}âŒ éœ€è¦ Node.js 18+ æ‰èƒ½åŸ·è¡Œæ­¤å·¥å…·${NC}"
        return 1
    fi
    
    # æª¢æŸ¥ Node.js ç‰ˆæœ¬
    local node_version=$(node -v | sed 's/v//')
    local min_version="18.0.0"
    local max_version="22.99.99"
    
    # æª¢æŸ¥æœ€ä½ç‰ˆæœ¬
    if [[ "$(printf '%s\n' "$min_version" "$node_version" | sort -V | head -n1)" != "$min_version" ]]; then
        echo -e "${RED}âŒ éœ€è¦ Node.js $min_version æˆ–æ›´é«˜ç‰ˆæœ¬ï¼Œç•¶å‰ç‰ˆæœ¬: $node_version${NC}"
        return 1
    fi
    
    # æª¢æŸ¥æœ€é«˜ç‰ˆæœ¬ï¼ˆè­¦å‘Šï¼‰
    if [[ "$(printf '%s\n' "$max_version" "$node_version" | sort -V | head -n1)" != "$node_version" ]]; then
        echo -e "${YELLOW}âš ï¸  Node.js ç‰ˆæœ¬ $node_version å¯èƒ½æœªç¶“å®Œæ•´æ¸¬è©¦${NC}"
        echo -e "${CYAN}ğŸ’¡ å»ºè­°ä½¿ç”¨ Node.js 18.x æˆ– 20.x LTS ç‰ˆæœ¬${NC}"
        echo -e "${CYAN}ğŸ’¡ å¦‚é‡åˆ°å•é¡Œï¼Œè«‹åƒè€ƒ scripts/UPGRADE.md${NC}"
    fi
    
    # ç¢ºä¿æ ¹å±¤ç´šä¾è³´å·²å®‰è£
    if [ ! -d "$TOOLS_DIR/node_modules" ]; then
        echo -e "${YELLOW}âš ï¸  å®‰è£å…±ç”¨ä¾è³´...${NC}"
        cd "$TOOLS_DIR" && pnpm install
    fi
    
    # ç¢ºä¿å·¥å…·ä¾è³´å·²å®‰è£
    if [ -f "$node_tool_dir/package.json" ] && [ ! -d "$node_tool_dir/node_modules" ]; then
        echo -e "${YELLOW}âš ï¸  å®‰è£å·¥å…·ä¾è³´...${NC}"
        cd "$node_tool_dir" && pnpm install
    fi
    
    # åŸ·è¡Œ Node.js å·¥å…·
    cd "$node_tool_dir"
    
    # å¦‚æœå·¥å…·åç¨±èˆ‡åˆ†é¡ç›¸åŒï¼Œç›´æ¥åŸ·è¡Œ CLI
    if [ "$tool_name" = "$category" ]; then
        node src/cli.js $args
    else
        # å¦å‰‡å‚³éå·¥å…·åç¨±ä½œç‚ºå­å‘½ä»¤
        node src/cli.js "$tool_name" $args
    fi
}

# äº’å‹•å¼é¸å–®
interactive_menu() {
    while true; do
        clear
        echo -e "${BOLD}ğŸ› ï¸  Development Toolkit - äº’å‹•å¼é¸å–®${NC}"
        echo ""
        
        local categories=($(get_categories))
        
        if [ ${#categories[@]} -eq 0 ]; then
            echo -e "${YELLOW}âš ï¸  æ²’æœ‰æ‰¾åˆ°ä»»ä½•å·¥å…·${NC}"
            return
        fi
        
        echo -e "${CYAN}è«‹é¸æ“‡åˆ†é¡ï¼š${NC}"
        local i=1
        
        for category in "${categories[@]}"; do
            local tool_count=$(get_category_tools "$category" | wc -l)
            echo "  $i. $category ($tool_count å€‹å·¥å…·)"
            ((i++))
        done
        
        echo "  $i. é€€å‡º"
        echo ""
        
        read -p "è«‹è¼¸å…¥é¸é … (1-$i): " choice
        
        if [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -ge 1 ] && [ "$choice" -le "$i" ]; then
            if [ "$choice" -eq "$i" ]; then
                echo -e "${YELLOW}ğŸ‘‹ å†è¦‹ï¼${NC}"
                break
            fi
            
            local selected_category="${categories[$((choice-1))]}"
            interactive_category_menu "$selected_category"
        else
            echo -e "${RED}âŒ ç„¡æ•ˆé¸é …ï¼Œè«‹é‡æ–°é¸æ“‡${NC}"
            read -p "æŒ‰ Enter ç¹¼çºŒ..."
        fi
    done
}

# äº’å‹•å¼åˆ†é¡é¸å–®
interactive_category_menu() {
    local category="$1"
    
    while true; do
        clear
        local category_display=$(echo "$category" | sed 's/./\U&/')
        echo -e "${BOLD}ğŸ”§ $category_display å·¥å…·é¸å–®${NC}"
        echo ""
        
        local tools_info=($(get_category_tools "$category"))
        local i=1
        
        get_category_tools "$category" | while IFS='|' read -r tool_name script_path description; do
            echo "  $i. $tool_name - $description"
            ((i++))
        done
        
        echo "  $i. è¿”å›ä¸Šç´šé¸å–®"
        echo ""
        
        read -p "è«‹è¼¸å…¥é¸é … (1-$i): " choice
        
        if [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -ge 1 ] && [ "$choice" -le "$i" ]; then
            if [ "$choice" -eq "$i" ]; then
                break
            fi
            
            # ç²å–é¸ä¸­çš„å·¥å…·
            local selected_tool=$(get_category_tools "$category" | sed -n "${choice}p" | cut -d'|' -f1)
            
            if [ -n "$selected_tool" ]; then
                echo ""
                execute_tool "${category}:${selected_tool}"
                echo ""
                read -p "æŒ‰ Enter ç¹¼çºŒ..."
            fi
        else
            echo -e "${RED}âŒ ç„¡æ•ˆé¸é …ï¼Œè«‹é‡æ–°é¸æ“‡${NC}"
            read -p "æŒ‰ Enter ç¹¼çºŒ..."
        fi
    done
}


# ä¸»ç¨‹å¼
main() {
    # è§£æå‘½ä»¤åˆ—åƒæ•¸
    case "${1:-}" in
        ""|"list")
            show_all_tools
            ;;
        "--help"|"-h")
            show_help
            ;;
        "--version"|"-v")
            show_version
            ;;
        "--interactive"|"-i")
            interactive_menu
            ;;
        *":"*)
            # åŸ·è¡ŒæŒ‡å®šå·¥å…·
            execute_tool "$@"
            ;;
        *)
            # é¡¯ç¤ºåˆ†é¡
            show_category_tools "$1"
            ;;
    esac
}

# åŸ·è¡Œä¸»ç¨‹å¼
main "$@"